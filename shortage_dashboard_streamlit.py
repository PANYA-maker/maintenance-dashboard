# =====================================
# Shortage Dashboard : EXECUTIVE VERSION (TOP NAVIGATION)
# MODERN UI & COMPREHENSIVE DATA
# UPDATED: Fixed Top 10 Causes Chart to match original visual style
# =====================================

import streamlit as st
import pandas as pd
import plotly.express as px

# ---------------- CSS Styling (Stable Modern UI) ----------------
st.markdown("""
<style>
    .main .block-container {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }
    .kpi-wrapper {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 10px;
    }
    .kpi-label {
        color: #64748b;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    .kpi-val {
        color: #1e293b;
        font-size: 1.6rem;
        font-weight: 700;
        margin: 5px 0;
    }
    .kpi-unit {
        color: #94a3b8;
        font-size: 0.75rem;
    }
    .section-header {
        color: #1e293b;
        font-weight: 700;
        font-size: 1.2rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid #6366f1;
        padding-left: 10px;
    }
    /* Styling for Tabs to look more like the reference image */
    .stTabs [data-baseweb="tab-list"] {
        gap: 24px;
        border-bottom: 1px solid #e2e8f0;
    }
    .stTabs [data-baseweb="tab"] {
        height: 50px;
        white-space: pre-wrap;
        background-color: transparent;
        border-radius: 4px 4px 0 0;
        gap: 1px;
        padding-top: 10px;
        color: #64748b;
    }
    .stTabs [aria-selected="true"] {
        color: #ef4444 !important;
        border-bottom: 2px solid #ef4444 !important;
        font-weight: 700;
    }
</style>
""", unsafe_allow_html=True)

# ---------------- Page Config ----------------
st.set_page_config(
    page_title="Shortage Intelligence Dashboard",
    page_icon="üìä",
    layout="wide"
)

# ---------------- Data Loading ----------------
SHEET_ID = "1gW0lw9XS0JYST-P-ZrXoFq0k4n2ZlXu9hOf3A--JV9U"
GID = "1799697899"
CSV_URL = f"https://docs.google.com/spreadsheets/d/{SHEET_ID}/export?format=csv&gid={GID}"

@st.cache_data(ttl=300)
def load_data():
    try:
        df = pd.read_csv(CSV_URL)
        df.columns = df.columns.str.strip()
        df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] = pd.to_datetime(df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"], dayfirst=True, errors="coerce")
        return df
    except Exception as e:
        st.error(f"Error loading data: {e}")
        return pd.DataFrame()

df = load_data()
if df.empty:
    st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
    st.stop()

# ---------------- Sidebar Filter Suite ----------------
with st.sidebar:
    st.title("‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á")
    
    if st.button("üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", use_container_width=True):
        st.cache_data.clear()
        st.rerun()
    
    st.markdown("---")
    max_date = df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].max()
    min_date = df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].min()
    
    if not pd.isna(max_date):
        default_start = max_date - pd.Timedelta(days=7)
    else:
        default_start = None

    date_range = st.date_input("üóìÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
        value=[default_start.date() if default_start else None, max_date.date() if not pd.isna(max_date) else None])
    
    mc_filter = st.multiselect("Machine (MC)", sorted(df["MC"].dropna().unique()))
    shift_filter = st.multiselect("‡∏Å‡∏∞ (Shift)", sorted(df["‡∏Å‡∏∞"].dropna().unique()))
    status_filter = st.multiselect("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï", sorted(df["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"].dropna().unique()))
    customer_filter = st.multiselect("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", sorted(df["‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"].dropna().unique()))
    
    stop_status_col = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ORDER ‡∏à‡∏≠‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏à‡∏≠‡∏î"
    if stop_status_col in df.columns:
        stop_status_filter = st.multiselect("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á", sorted(df[stop_status_col].dropna().unique()))
    else:
        stop_status_filter = []

    period = st.selectbox("‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°", ["‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå", "‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô", "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", "‡∏£‡∏≤‡∏¢‡∏õ‡∏µ"])

# ---------------- Apply Filter Logic ----------------
fdf = df.copy()
if len(date_range) == 2:
    fdf = fdf[(fdf["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] >= pd.to_datetime(date_range[0])) & (fdf["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] <= pd.to_datetime(date_range[1]))]
if mc_filter: fdf = fdf[fdf["MC"].isin(mc_filter)]
if shift_filter: fdf = fdf[fdf["‡∏Å‡∏∞"].isin(shift_filter)]
if status_filter: fdf = fdf[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"].isin(status_filter)]
if customer_filter: fdf = fdf[fdf["‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"].isin(customer_filter)]
if stop_status_filter: fdf = fdf[fdf[stop_status_col].isin(stop_status_filter)]

# ---------------- Header Analytics ----------------
st.markdown(f"""
    <div style="margin-bottom: 5px;">
        <h1 style="margin:0; color:#1e293b; font-size:2.2rem;">Shortage Performance Intelligence</h1>
    </div>
""", unsafe_allow_html=True)

# Shared Calculations
order_total = len(fdf)
short_qty = (fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô").sum()
missing_meters = pd.to_numeric(fdf.loc[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"], errors="coerce").sum()
missing_weight = pd.to_numeric(fdf.loc[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"], errors="coerce").sum()
pdw_scrap_val = pd.to_numeric(fdf.loc[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ PDW"], errors="coerce").sum()

# ---------------- TOP NAVIGATION TABS ----------------
tab1, tab2 = st.tabs(["üìä Executive Overview", "üõ†Ô∏è Detailed Logs / Repair"])

# ==============================================================================
# TAB 1: EXECUTIVE OVERVIEW
# ==============================================================================
with tab1:
    st.markdown('<p style="color:#64748b; font-size:1.1rem; margin-bottom:20px;">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô | ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Week Cycle: ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå - ‡πÄ‡∏™‡∏≤‡∏£‡πå)</p>', unsafe_allow_html=True)
    
    # Section 1: Operational Summary
    complete_qty = (fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô").sum()
    short_pct = (short_qty / order_total * 100) if order_total > 0 else 0

    st.markdown('<div class="section-header">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô (Operational Summary)</div>', unsafe_allow_html=True)
    c1, c2, c3, c4 = st.columns(4)

    def kpi_box(label, value, subtext, color="#1e293b"):
        st.markdown(f"""
            <div class="kpi-wrapper">
                <div class="kpi-label">{label}</div>
                <div class="kpi-val" style="color:{color};">{value}</div>
                <div class="kpi-unit">{subtext}</div>
            </div>
        """, unsafe_allow_html=True)

    with c1: kpi_box("Order Total", f"{order_total:,}", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
    with c2: kpi_box("Completed", f"{complete_qty:,}", "‡∏ú‡∏•‡∏¥‡∏ï‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô", "#10b981")
    with c3: kpi_box("Shortage", f"{short_qty:,}", "‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (Order)", "#ef4444")
    with c4: 
        color_rate = "#ef4444" if short_pct > 15 else "#f59e0b" if short_pct > 10 else "#10b981"
        kpi_box("Shortage Rate", f"{short_pct:.1f}%", "‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", color_rate)

    # Section 2: Physical Loss Impact
    st.markdown('<div class="section-header">üìè ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏ç‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏ä‡∏¥‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Physical Loss Impact)</div>', unsafe_allow_html=True)
    missing_sqm = pd.to_numeric(fdf.loc[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"], errors="coerce").sum()
    
    m1, m2, m3, m4 = st.columns(4)
    with m1: kpi_box("Missing Meters", f"{missing_meters:,.0f}", "‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡πÄ‡∏°‡∏ï‡∏£")
    with m2: kpi_box("Missing Area", f"{missing_sqm:,.0f}", "‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£")
    with m3: kpi_box("Missing Weight", f"{missing_weight:,.0f}", "‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°")
    with m4: kpi_box("PDW Scrap Weight", f"{pdw_scrap_val:,.0f}", "‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ PDW (kg)", "#b45309")

    # Section 3: Machine Performance Analysis
    st.markdown('<div class="section-header">üñ•Ô∏è ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏¢‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Machine Performance Analysis)</div>', unsafe_allow_html=True)
    mc_perf = fdf.copy()
    if not mc_perf.empty:
        mc_summary = mc_perf.groupby(['MC', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï']).size().reset_index(name='‡∏à‡∏≥‡∏ô‡∏ß‡∏ô')
        mc_total = mc_summary.groupby('MC')['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'].transform('sum')
        mc_summary['%'] = (mc_summary['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'] / mc_total * 100).round(1)
        mc_summary['label_display'] = mc_summary.apply(lambda x: f'{int(x["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"])} ({x["%"]}%)', axis=1)
        sort_helper = mc_summary[mc_summary['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï'] == '‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'][['MC', '%']].rename(columns={'%': 'sort_pct'})
        mc_summary = mc_summary.merge(sort_helper, on='MC', how='left').fillna({'sort_pct': 0})
        mc_summary = mc_summary.sort_values(['sort_pct', 'MC'], ascending=[True, True])
        
        fig_mc = px.bar(mc_summary, x="%", y="MC", color="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï", orientation="h",
                        title="‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£",
                        text="label_display", barmode="stack", 
                        category_orders={"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï": ["‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏•‡∏¥‡∏ï"]},
                        color_discrete_map={"‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": "#10b981", "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": "#ef4444", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏•‡∏¥‡∏ï": "#94a3b8"})
        fig_mc.update_traces(textposition="inside", textfont=dict(size=12, color="white", family="Arial Black"), marker_line_width=0)
        fig_mc.update_layout(xaxis_range=[0, 105], plot_bgcolor='rgba(0,0,0,0)', xaxis_title="‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏™‡∏∞‡∏™‡∏° (%)", 
                             yaxis_title=None, height=min(400 + (len(mc_summary['MC'].unique()) * 30), 800),
                             legend=dict(orientation="h", yanchor="bottom", y=1.02, xanchor="right", x=1))
        st.plotly_chart(fig_mc, use_container_width=True)

    # Section 4: Deep Dive & Trend
    st.markdown('<div class="section-header">üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (Deep Dive Analysis)</div>', unsafe_allow_html=True)
    col_left, col_mid, col_right = st.columns([2, 1, 1])
    
    with col_left:
        # FIXED: Top 10 Causes Chart (Matching image_be3377.png)
        top10 = fdf[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"].groupby("Detail").size().sort_values().tail(10).reset_index(name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô")
        if not top10.empty:
            fig_top10 = px.bar(top10, x="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", y="Detail", orientation="h", 
                              title="TOP 10 ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", 
                              color="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", 
                              color_continuous_scale="Reds", 
                              text="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô")
            fig_top10.update_traces(textposition="inside", textfont=dict(size=12, color="white"))
            fig_top10.update_layout(
                plot_bgcolor='white', 
                paper_bgcolor='white',
                margin=dict(t=50, b=0),
                coloraxis_colorbar=dict(title="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"),
                xaxis=dict(showgrid=True, gridcolor='lightgrey'),
                yaxis=dict(showgrid=False)
            )
            st.plotly_chart(fig_top10, use_container_width=True)

    with col_mid:
        status_df = fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"].value_counts().reset_index(); status_df.columns = ["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]
        fig_status = px.pie(status_df, names="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", values="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", title="‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï (Overall)",
                           color="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", color_discrete_map={"‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": "#10b981", "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": "#ef4444", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏•‡∏¥‡∏ï": "#94a3b8"})
        fig_status.update_traces(textinfo="value+percent", textfont_size=11); fig_status.update_layout(margin=dict(t=40, b=0, l=0, r=0), showlegend=True, legend=dict(orientation="h", y=-0.1))
        st.plotly_chart(fig_status, use_container_width=True)
        
    with col_right:
        short_df = fdf[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]; stop_col = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ORDER ‡∏à‡∏≠‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏à‡∏≠‡∏î"
        if stop_col in short_df.columns:
            stop_summary = short_df[stop_col].value_counts().reset_index(); stop_summary.columns = ["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≠‡∏î", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]
            fig_stop = px.pie(stop_summary, names="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≠‡∏î", values="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", title="‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î)", color_discrete_sequence=px.colors.qualitative.Safe)
            fig_stop.update_traces(textinfo="value+percent", textfont_size=11); fig_stop.update_layout(margin=dict(t=40, b=0, l=0, r=0), showlegend=True, legend=dict(orientation="h", y=-0.1))
            st.plotly_chart(fig_stop, use_container_width=True)

    st.markdown("#### üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤")
    trend = fdf.copy()
    if not trend.empty:
        if period == "‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô": 
            trend["‡∏ä‡πà‡∏ß‡∏á_dt"] = trend["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].dt.normalize(); trend["‡∏ä‡πà‡∏ß‡∏á"] = trend["‡∏ä‡πà‡∏ß‡∏á_dt"].dt.strftime("%d/%m/%Y")
        elif period == "‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå": 
            trend["‡∏ä‡πà‡∏ß‡∏á_dt"] = trend["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] - pd.to_timedelta((trend["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].dt.weekday + 1) % 7, unit='D')
            # Updated week logic for Sunday start with offset +1
            week_nums = trend["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].dt.strftime("%U").astype(int) + 1; trend["‡∏ä‡πà‡∏ß‡∏á"] = "Week " + week_nums.apply(lambda x: f"{x:02d}")
        elif period == "‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô": 
            trend["‡∏ä‡πà‡∏ß‡∏á_dt"] = trend["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].dt.to_period("M").dt.to_timestamp(); trend["‡∏ä‡πà‡∏ß‡∏á"] = trend["‡∏ä‡πà‡∏ß‡∏á_dt"].dt.strftime("%b %Y")
        else: 
            trend["‡∏ä‡πà‡∏ß‡∏á_dt"] = trend["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].dt.to_period("Y").dt.to_timestamp(); trend["‡∏ä‡πà‡∏ß‡∏á"] = trend["‡∏ä‡πà‡∏ß‡∏á_dt"].dt.year.astype(str)

        sum_trend = trend.groupby(["‡∏ä‡πà‡∏ß‡∏á_dt", "‡∏ä‡πà‡∏ß‡∏á", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"]).size().reset_index(name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô")
        total_in_period = sum_trend.groupby("‡∏ä‡πà‡∏ß‡∏á_dt")["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"].transform("sum")
        sum_trend["%"] = (sum_trend["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"] / total_in_period * 100).round(1); sum_trend["label_display"] = sum_trend.apply(lambda x: f'{int(x["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"])} ({x["%"]}%)', axis=1)
        sum_trend = sum_trend.sort_values("‡∏ä‡πà‡∏ß‡∏á_dt")
        
        cust_display = f" | ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: {', '.join(customer_filter)}" if customer_filter and len(customer_filter) <= 3 else (f" | ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ {len(customer_filter)} ‡∏£‡∏≤‡∏¢" if customer_filter else "")
        fig_trend = px.bar(sum_trend, x="‡∏ä‡πà‡∏ß‡∏á", y="%", color="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï", title=f"‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ({period}){cust_display}",
                          text="label_display", barmode="stack", category_orders={"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï": ["‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏•‡∏¥‡∏ï"]},
                          color_discrete_map={"‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": "#10b981", "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": "#ef4444", "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ú‡∏•‡∏¥‡∏ï": "#94a3b8"})
        fig_trend.update_layout(xaxis={'type': 'category', 'categoryorder': 'array', 'categoryarray': sum_trend['‡∏ä‡πà‡∏ß‡∏á'].unique()},
                                yaxis_range=[0, 115], plot_bgcolor='white', legend=dict(orientation="h", y=-0.2), margin=dict(t=50))
        fig_trend.update_traces(textposition="inside", textfont=dict(size=10, color="white"), insidetextanchor="middle")
        st.plotly_chart(fig_trend, use_container_width=True)

# ==============================================================================
# TAB 2: DETAILED LOGS / REPAIR
# ==============================================================================
with tab2:
    st.markdown('<div class="section-header">üõ†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ PDW (Repair Workstream)</div>', unsafe_allow_html=True)
    
    if "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ" in fdf.columns:
        # Data Preparation
        repair_summary_data = fdf[fdf["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏•‡∏¥‡∏ï"] == "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"].dropna(subset=["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ"]).copy()
        metrics = ["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"]
        for m in metrics:
            repair_summary_data[m] = pd.to_numeric(repair_summary_data[m], errors='coerce').fillna(0)
        
        # Grouping
        issue_df = repair_summary_data.groupby("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ").agg({
            '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ': 'size',
            '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': 'sum',
            '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': 'sum',
            '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô': 'sum'
        }).rename(columns={'‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ': '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå'}).reset_index().sort_values("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå", ascending=False)
        
        total_orders = issue_df["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"].sum()
        total_meters = issue_df["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"].sum()
        total_sqm = issue_df["‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"].sum()
        total_weight = issue_df["‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"].sum()

        # Build Total Row
        total_row = pd.DataFrame([{
            "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ": "‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå": total_orders,
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": total_meters,
            "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": total_sqm,
            "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": total_weight
        }])
        issue_df = pd.concat([issue_df, total_row], ignore_index=True)
        issue_df.columns = ["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå", "‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ï‡∏£ (m)", "‡∏£‡∏ß‡∏° ‡∏ï‡∏£.‡∏°.", "‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)"]

        # RESTORED SUMMARY BOX (Matching image_be9899.png)
        st.markdown(f"""
        <div style="background-color: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;">
            <p style="margin:0; font-size: 1.1rem; color: #334155;">
                <b>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°:</b> ‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <b>{total_orders:,}</b> ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô | 
                ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>{total_weight:,.0f}</b> ‡∏Å‡∏Å. | 
                ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ PDW ‡∏™‡∏∞‡∏™‡∏° <b>{pdw_scrap_val:,.0f}</b> ‡∏Å‡∏Å.
            </p>
        </div>
        """, unsafe_allow_html=True)

        t1, t2 = st.columns([1.8, 1])
        with t1:
            st.markdown("**‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å**")
            st.dataframe(
                issue_df.style.format({
                    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå": "{:,}",
                    "‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ï‡∏£ (m)": "{:,.0f}",
                    "‡∏£‡∏ß‡∏° ‡∏ï‡∏£.‡∏°.": "{:,.0f}",
                    "‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (kg)": "{:,.0f}"
                }),
                use_container_width=True, hide_index=True
            )
        with t2:
            issue_df_pie = issue_df[issue_df["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°"] != "‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]
            fig_repair = px.pie(issue_df_pie, names="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°", values="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå", hole=0.5, title="‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°")
            fig_repair.update_traces(textinfo="label+percent", textposition="inside", textfont_size=11, textfont_color="white")
            fig_repair.update_layout(margin=dict(t=30, b=0), showlegend=False)
            st.plotly_chart(fig_repair, use_container_width=True)

    # Data Explorer Expander (Moved to Tab 2 to keep Overview clean)
    with st.expander("üìÑ ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Detailed Orders)"):
        st.markdown("üîç **‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á**")
        f_c1, f_c2, f_c3 = st.columns(3)
        target_columns = ["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà", "MC", "‡∏Å‡∏∞", "PDR No.", "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "‡∏•‡∏≠‡∏ô", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", "‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô", "Detail", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏£‡∏∏‡∏õ", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ORDER ‡∏à‡∏≠‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏à‡∏≠‡∏î"]
        search_pdr = f_c1.text_input("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ PDR No.", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç PDR..."); search_cust = f_c2.text_input("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..."); search_detail = f_c3.text_input("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Detail/‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏", placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏...")
        fdf_table = fdf.copy()
        if search_pdr: fdf_table = fdf_table[fdf_table["PDR No."].astype(str).str.contains(search_pdr, case=False, na=False)]
        if search_cust: fdf_table = fdf_table[fdf_table["‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"].astype(str).str.contains(search_cust, case=False, na=False)]
        if search_detail: fdf_table = fdf_table[fdf_table["Detail"].astype(str).str.contains(search_detail, case=False, na=False)]
        fdf_table["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"] = fdf_table["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"].dt.strftime("%d/%m/%Y"); available_cols = [c for c in target_columns if c in fdf_table.columns]
        st.markdown(f"‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î **{len(fdf_table):,}** ‡πÅ‡∏ñ‡∏ß")
        st.dataframe(fdf_table[available_cols].sort_values("‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà", ascending=True), use_container_width=True, hide_index=True)

st.caption("Shortage Intelligence Dashboard | Original Visual Style Restored | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô 100%")
